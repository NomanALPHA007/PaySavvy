<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>PaySavvy Pro - AI Scam Link Detector</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>
    
    <!-- Chart.js for analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- QR Code Scanner - Alternative library -->
    <script src="https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.umd.min.js"></script>
    
    <style>
        :root {
            --primary-color: #059669;
            --primary-light: #10b981;
            --primary-dark: #047857;
            --secondary-color: #6b7280;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --dark-bg: #064e3b;
            --card-bg: #ffffff;
            --text-primary: #064e3b;
            --text-secondary: #374151;
            --border-color: #d1fae5;
            --accent-green: #dcfce7;
            --chat-bg: #f8fafc;
            --user-msg: #059669;
            --bot-msg: #e5e7eb;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 50%, #bbf7d0 100%);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
        }

        .main-container {
            min-height: 100vh;
            padding: 1rem;
        }

        .app-header {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
        }

        .logo {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .tagline {
            color: var(--text-secondary);
            font-size: 1.1rem;
            margin-bottom: 0;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .feature-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border: 1px solid var(--border-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }

        .form-control {
            border-radius: 12px;
            border: 2px solid var(--border-color);
            padding: 0.75rem 1rem;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(5, 150, 105, 0.25);
        }

        .btn-primary {
            background: var(--primary-color);
            border: none;
            border-radius: 12px;
            padding: 0.75rem 2rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-outline-primary {
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            border-radius: 12px;
            padding: 0.5rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-outline-primary:hover {
            background: var(--primary-color);
            border-color: var(--primary-color);
            transform: translateY(-1px);
        }

        .alert {
            border-radius: 12px;
            border: none;
            padding: 1rem 1.5rem;
            margin-bottom: 1rem;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
            border-left: 4px solid var(--success-color);
        }

        .alert-warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
            border-left: 4px solid var(--warning-color);
        }

        .alert-danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
            border-left: 4px solid var(--danger-color);
        }

        /* Chat Interface Styles */
        .chat-container {
            background: var(--card-bg);
            border-radius: 20px;
            height: 600px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
        }

        .chat-header {
            background: var(--primary-color);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 20px 20px 0 0;
            font-weight: 600;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: var(--chat-bg);
        }

        .message {
            margin-bottom: 1rem;
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-content {
            background: var(--bot-msg);
            padding: 0.75rem 1rem;
            border-radius: 12px;
            max-width: 70%;
            word-wrap: break-word;
        }

        .message.user .message-content {
            background: var(--user-msg);
            color: white;
        }

        .chat-input-container {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            background: var(--card-bg);
            border-radius: 0 0 20px 20px;
        }

        .chat-input {
            width: 100%;
            border: 2px solid var(--border-color);
            border-radius: 25px;
            padding: 0.75rem 1rem;
            resize: none;
            transition: border-color 0.3s ease;
        }

        .chat-input:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        /* QR Scanner Styles */
        .qr-container {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
        }

        #qr-reader {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            border-radius: 12px;
            overflow: hidden;
        }

        .qr-mode-toggle {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-bottom: 1rem;
        }

        .collapsible-card {
            background: var(--card-bg);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .collapsible-header {
            padding: 1rem 1.5rem;
            background: var(--accent-green);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s ease;
        }

        .collapsible-header:hover {
            background: var(--border-color);
        }

        .collapsible-content {
            padding: 1.5rem;
            display: none;
        }

        .collapsible-content.show {
            display: block;
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }

        .toast {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 0.5rem;
            min-width: 300px;
        }

        /* Professional AI Chat Formatting */
        .scam-item {
            margin: 12px 0;
            padding: 10px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .scam-item:last-child {
            border-bottom: none;
        }

        .scam-item strong {
            color: #dc3545;
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
        }

        .message-section {
            margin-bottom: 16px;
        }

        .message-section:last-child {
            margin-bottom: 0;
        }

        .message.bot .message-content {
            line-height: 1.7;
            font-size: 14px;
        }

        .message.bot .message-content strong {
            font-weight: 600;
            color: #2c5aa0;
        }

        /* QR Scanner Enhanced Styling */
        .qr-analysis-result {
            margin-top: 1rem;
        }

        .payment-info {
            background: rgba(0, 123, 255, 0.1);
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }

        .risk-assessment {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 12px 0;
        }

        .warnings {
            background: rgba(220, 53, 69, 0.1);
            padding: 10px;
            border-radius: 6px;
            border-left: 3px solid #dc3545;
        }

        .recommendations {
            background: rgba(25, 135, 84, 0.1);
            padding: 10px;
            border-radius: 6px;
            border-left: 3px solid #198754;
        }

        .warnings ul, .recommendations ul {
            margin: 6px 0 0 0;
            padding-left: 20px;
        }

        .warnings li, .recommendations li {
            margin-bottom: 4px;
        }

        #qr-reader {
            border: 2px solid #dee2e6;
            border-radius: 12px;
            overflow: hidden;
            background: #f8f9fa;
        }

        #qr-reader video {
            border-radius: 10px;
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 0.5rem;
            }
            
            .app-header {
                padding: 1.5rem;
            }
            
            .logo {
                font-size: 2rem;
            }
            
            .feature-grid {
                grid-template-columns: 1fr;
            }
            
            .chat-container {
                height: 500px;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- App Header -->
        <div class="app-header text-center">
            <div class="logo">🛡️ PaySavvy Pro</div>
            <p class="tagline">Advanced AI-Powered Cybersecurity Platform for Malaysia</p>
            <div class="mt-3">
                <span class="badge bg-success me-2">✓ AI Analysis</span>
                <span class="badge bg-info me-2">✓ QR Scanner</span>
                <span class="badge bg-warning me-2">✓ Multilingual</span>
                <span class="badge bg-primary">✓ Real-time Protection</span>
            </div>
        </div>

        <!-- Feature Grid -->
        <div class="feature-grid">
            <!-- URL Scanner -->
            <div class="feature-card">
                <h5 class="mb-3"><i data-feather="shield" class="me-2"></i>URL Link Scanner</h5>
                <div class="mb-3">
                    <input type="url" id="urlInput" class="form-control" placeholder="Paste suspicious link here..." />
                </div>
                <button id="scanButton" class="btn btn-primary w-100">
                    <i data-feather="search" class="me-2"></i>Scan Link Now
                </button>
                <div id="results" class="mt-3" style="display: none;"></div>
            </div>

            <!-- QR Code Scanner -->
            <div class="feature-card">
                <h5 class="mb-3"><i data-feather="camera" class="me-2"></i>QR Code Scanner</h5>
                <div class="qr-mode-toggle">
                    <button id="cameraMode" class="btn btn-outline-primary btn-sm active">Camera</button>
                    <button id="fileMode" class="btn btn-outline-primary btn-sm">Upload File</button>
                </div>
                <div id="qr-reader-container">
                    <video id="qr-reader" style="width: 100%; max-width: 400px; border-radius: 8px;"></video>
                    <input type="file" id="qr-file-input" accept="image/*" style="display: none;" />
                    <button id="qr-file-button" class="btn btn-secondary w-100 mt-2" style="display: none;">
                        <i data-feather="upload" class="me-2"></i>Choose QR Image
                    </button>
                </div>
                <div id="qr-results" class="mt-3"></div>
            </div>

            <!-- AI Chatbot -->
            <div class="feature-card">
                <h5 class="mb-3"><i data-feather="message-circle" class="me-2"></i>AI Security Assistant</h5>
                <div class="chat-container">
                    <div class="chat-header">
                        <span>💬 Cybersecurity Expert</span>
                    </div>
                    <div id="chatMessages" class="chat-messages">
                        <div class="message">
                            <div class="message-content">
                                Hello! I'm your AI cybersecurity assistant. Ask me about online scams, suspicious links, or security best practices for Malaysia.
                            </div>
                        </div>
                    </div>
                    <div class="chat-input-container">
                        <div class="d-flex gap-2 mb-2">
                            <button class="btn btn-outline-primary btn-sm quick-chat" data-question="How to identify fake banking websites?">Banking Scams</button>
                            <button class="btn btn-outline-primary btn-sm quick-chat" data-question="What are common e-wallet scams in Malaysia?">E-wallet Safety</button>
                            <button class="btn btn-outline-primary btn-sm quick-chat" data-question="How to report cybercrime in Malaysia?">Report Scam</button>
                        </div>
                        <div class="d-flex gap-2">
                            <textarea id="chatInput" class="chat-input" rows="1" placeholder="Ask about cybersecurity..."></textarea>
                            <button id="sendChat" class="btn btn-primary">
                                <i data-feather="send" width="16" height="16"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Advanced Analysis Results -->
        <div id="advancedResults" style="display: none;">
            <div class="collapsible-card">
                <div class="collapsible-header" data-target="fingerprintAnalysis">
                    <span><i data-feather="shield" class="me-2"></i>Scam DNA Fingerprinting</span>
                    <i data-feather="chevron-down"></i>
                </div>
                <div id="fingerprintAnalysis" class="collapsible-content">
                    <div id="fingerprintResults"></div>
                </div>
            </div>

            <div class="collapsible-card">
                <div class="collapsible-header" data-target="redirectAnalysis">
                    <span><i data-feather="arrow-right-circle" class="me-2"></i>Redirect Chain Analysis</span>
                    <i data-feather="chevron-down"></i>
                </div>
                <div id="redirectAnalysis" class="collapsible-content">
                    <div id="redirectResults"></div>
                </div>
            </div>

            <div class="collapsible-card">
                <div class="collapsible-header" data-target="multilingualAnalysis">
                    <span><i data-feather="globe" class="me-2"></i>Multilingual Threat Detection</span>
                    <i data-feather="chevron-down"></i>
                </div>
                <div id="multilingualAnalysis" class="collapsible-content">
                    <div id="multilingualResults"></div>
                </div>
            </div>

            <div class="collapsible-card">
                <div class="collapsible-header" data-target="regionalRisk">
                    <span><i data-feather="map" class="me-2"></i>Regional Risk Assessment</span>
                    <i data-feather="chevron-down"></i>
                </div>
                <div id="regionalRisk" class="collapsible-content">
                    <div id="regionalResults"></div>
                    <canvas id="riskHeatmap" width="400" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- Scan History -->
        <div class="collapsible-card">
            <div class="collapsible-header" data-target="scanHistory">
                <span><i data-feather="clock" class="me-2"></i>Recent Scans</span>
                <i data-feather="chevron-down"></i>
            </div>
            <div id="scanHistory" class="collapsible-content">
                <div id="historyContent">
                    <p class="text-muted">No scans yet. Start by analyzing a suspicious link above.</p>
                </div>
                <button id="clearHistory" class="btn btn-outline-danger btn-sm mt-2" style="display: none;">
                    <i data-feather="trash-2" class="me-1"></i>Clear History
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container"></div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Main Application Script -->
    <script>
        // PaySavvy Pro - Complete Vercel-Ready Application
        class PaySavvyPro {
            constructor() {
                this.apiKey = this.getApiKey();
                this.baseUrl = 'https://api.openai.com/v1/chat/completions';
                this.qrScanner = null;
                this.scanHistory = this.loadScanHistory();
                this.malaysianBanks = [
                    'maybank', 'publicbank', 'rhb', 'cimb', 'ambank', 'bsn', 'agrobank',
                    'bankislam', 'bankmuamalat', 'affinbank', 'alliancebank', 'hongleong'
                ];
                this.ewallets = [
                    'grabpay', 'tng', 'boost', 'shopee', 'bigpay', 'mcash', 'vcash',
                    'maybank2u', 'cimbclicks', 'rhbnow', 'publicbank2u'
                ];
                this.init();
            }

            getApiKey() {
                // Multiple sources for API key detection
                return window.ENV?.VITE_OPENAI_API_KEY || 
                       window.VITE_OPENAI_API_KEY || 
                       window.OPENAI_API_KEY ||
                       localStorage.getItem('openai_api_key') || 
                       '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';
            }

            init() {
                this.setupEventListeners();
                this.initializeQRScanner();
                this.displayScanHistory();
                feather.replace();
                this.showWelcomeMessage();
                console.log('PaySavvy Pro initialized successfully');
            }

            setupEventListeners() {
                // URL Scanner
                document.getElementById('scanButton').addEventListener('click', () => this.handleScan());
                document.getElementById('urlInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.handleScan();
                });

                // QR Scanner modes
                document.getElementById('cameraMode').addEventListener('click', () => this.switchQRMode('camera'));
                document.getElementById('fileMode').addEventListener('click', () => this.switchQRMode('file'));
                document.getElementById('qr-file-button').addEventListener('click', () => {
                    document.getElementById('qr-file-input').click();
                });
                document.getElementById('qr-file-input').addEventListener('change', (e) => this.handleQRFile(e));

                // Chat functionality
                document.getElementById('sendChat').addEventListener('click', () => this.sendChatMessage());
                document.getElementById('chatInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendChatMessage();
                    }
                });

                // Quick chat buttons
                document.querySelectorAll('.quick-chat').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const question = e.target.dataset.question;
                        document.getElementById('chatInput').value = question;
                        this.sendChatMessage();
                    });
                });

                // Collapsible sections
                document.querySelectorAll('.collapsible-header').forEach(header => {
                    header.addEventListener('click', () => this.toggleCollapsible(header));
                });

                // Clear history
                document.getElementById('clearHistory').addEventListener('click', () => this.clearScanHistory());
            }

            async handleScan() {
                const url = document.getElementById('urlInput').value.trim();
                if (!url) {
                    this.showToast('Error', 'Please enter a URL to scan', 'error');
                    return;
                }

                if (!this.isValidUrl(url)) {
                    this.showToast('Error', 'Please enter a valid URL', 'error');
                    return;
                }

                this.setLoadingState(true);

                try {
                    const results = await this.performComprehensiveAnalysis(url);
                    this.displayResults(results);
                    this.saveScanResult(results);
                    this.displayScanHistory();
                } catch (error) {
                    console.error('Scan error:', error);
                    this.showToast('Error', 'Failed to analyze URL: ' + error.message, 'error');
                } finally {
                    this.setLoadingState(false);
                }
            }

            async performComprehensiveAnalysis(url) {
                const results = {
                    url,
                    timestamp: new Date().toISOString(),
                    basicAnalysis: this.performBasicAnalysis(url),
                    aiAnalysis: null,
                    fingerprint: this.generateFingerprint(url),
                    redirectChain: await this.analyzeRedirectChain(url),
                    multilingualAnalysis: this.performMultilingualAnalysis(url),
                    regionalRisk: this.assessRegionalRisk(url)
                };

                // AI Analysis (if API key available)
                if (this.apiKey) {
                    try {
                        results.aiAnalysis = await this.performAIAnalysis(url);
                    } catch (error) {
                        console.warn('AI analysis failed:', error);
                        results.aiAnalysis = { error: 'AI analysis unavailable - check API key configuration' };
                    }
                }

                return results;
            }

            performBasicAnalysis(url) {
                let score = 0;
                const flags = [];
                const domain = this.extractDomain(url);

                // Check for suspicious patterns
                const suspiciousPatterns = [
                    { pattern: /bit\.ly|tinyurl|short|redirect/i, points: 2, flag: 'URL shortener detected' },
                    { pattern: /urgent|immediate|verify|suspend|expire/i, points: 3, flag: 'Urgency keywords detected' },
                    { pattern: /login|signin|account|bank|payment/i, points: 2, flag: 'Sensitive keywords detected' },
                    { pattern: /[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}/i, points: 3, flag: 'IP address instead of domain' },
                    { pattern: /-/g, points: 1, flag: 'Multiple hyphens in domain' }
                ];

                suspiciousPatterns.forEach(({ pattern, points, flag }) => {
                    if (pattern.test(url)) {
                        score += points;
                        flags.push(flag);
                    }
                });

                // Check for typosquatting
                const typoSquatting = this.checkTyposquatting(domain);
                if (typoSquatting) {
                    score += 4;
                    flags.push(`Possible typosquatting of ${typoSquatting}`);
                }

                const riskLevel = score >= 5 ? 'dangerous' : score >= 3 ? 'suspicious' : 'safe';
                const explanation = this.generateExplanation(riskLevel, flags);

                return { riskLevel, score, flags, explanation };
            }

            checkTyposquatting(domain) {
                const allBrands = [...this.malaysianBanks, ...this.ewallets];
                
                for (const brand of allBrands) {
                    if (domain.includes(brand) && !this.isLegitemateDomain(domain, brand)) {
                        return brand;
                    }
                }
                return null;
            }

            isLegitemateDomain(domain, brand) {
                const legitimateDomains = {
                    'maybank': ['maybank2u.com.my', 'maybank.com.my'],
                    'publicbank': ['pbebank.com', 'publicbank.com.my'],
                    'rhb': ['rhbgroup.com', 'rhbnow.com'],
                    'cimb': ['cimb.com.my', 'cimbclicks.com.my'],
                    'tng': ['tngdigital.com.my', 'touchngo.com.my'],
                    'grabpay': ['grab.com', 'grab.com.my'],
                    'boost': ['myboost.com.my']
                };

                return legitimateDomains[brand]?.some(legitDomain => domain.includes(legitDomain)) || false;
            }

            async performAIAnalysis(url) {
                if (!this.apiKey) {
                    throw new Error('OpenAI API key not configured');
                }

                const prompt = `Analyze this URL for potential scam/phishing threats: ${url}

Consider:
- Domain reputation and legitimacy
- URL structure and patterns
- Potential targeting of Malaysian users
- Banking/financial service impersonation
- E-wallet fraud indicators

Respond with JSON:
{
  "riskLevel": "safe|suspicious|dangerous",
  "confidence": 0-100,
  "explanation": "detailed analysis",
  "threats": ["list of specific threats"],
  "recommendations": ["list of recommendations"]
}`;

                const response = await fetch(this.baseUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${this.apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o',
                        messages: [
                            { role: 'system', content: 'You are a cybersecurity expert specializing in Malaysian online scams and phishing detection.' },
                            { role: 'user', content: prompt }
                        ],
                        max_tokens: 500,
                        temperature: 0.1
                    })
                });

                if (!response.ok) {
                    throw new Error(`AI analysis failed: ${response.status}`);
                }

                const data = await response.json();
                const content = data.choices[0].message.content;
                
                try {
                    return JSON.parse(content);
                } catch {
                    return {
                        riskLevel: 'unknown',
                        confidence: 0,
                        explanation: content,
                        threats: [],
                        recommendations: []
                    };
                }
            }

            generateFingerprint(url) {
                const domain = this.extractDomain(url);
                const patterns = [
                    url.length,
                    domain.split('.').length,
                    (url.match(/-/g) || []).length,
                    (url.match(/[0-9]/g) || []).length,
                    (url.match(/[A-Z]/g) || []).length,
                    url.includes('https') ? 1 : 0
                ];

                const hash = this.simpleHash(url).toString(16).substring(0, 8);
                const riskScore = this.calculateFingerprintRisk(patterns);

                return {
                    domain,
                    patterns,
                    hash,
                    riskScore,
                    matchedScams: this.checkFingerprintDatabase(hash)
                };
            }

            async analyzeRedirectChain(url) {
                try {
                    const steps = [
                        {
                            url: url,
                            status: 'direct',
                            risk: this.isUrlShortener(url) ? 'high' : 'low'
                        }
                    ];

                    return {
                        originalUrl: url,
                        steps,
                        finalUrl: url,
                        redirectCount: 0,
                        suspiciousRedirects: 0,
                        riskLevel: 'safe'
                    };
                } catch (error) {
                    return {
                        originalUrl: url,
                        steps: [],
                        finalUrl: url,
                        redirectCount: 0,
                        suspiciousRedirects: 0,
                        riskLevel: 'unknown',
                        error: error.message
                    };
                }
            }

            performMultilingualAnalysis(url) {
                const scamKeywords = {
                    english: ['urgent', 'verify', 'suspend', 'expired', 'confirm', 'update'],
                    malay: ['segera', 'sahkan', 'gantung', 'tamat', 'kemaskini', 'pengesahan'],
                    chinese: ['紧急', '验证', '暂停', '过期', '确认', '更新'],
                    tamil: ['அவசர', 'சரிபார', 'நிறுத்து', 'காலாவதி', 'உறுதிப்படுத்து']
                };

                const detectedLanguages = [];
                const foundKeywords = [];
                let riskScore = 0;

                Object.entries(scamKeywords).forEach(([lang, keywords]) => {
                    const matches = keywords.filter(keyword => 
                        url.toLowerCase().includes(keyword.toLowerCase())
                    );
                    if (matches.length > 0) {
                        detectedLanguages.push(lang);
                        foundKeywords.push(...matches);
                        riskScore += matches.length;
                    }
                });

                return {
                    detectedLanguages,
                    scamKeywords: foundKeywords,
                    riskScore,
                    regionalThreats: this.getRegionalThreats(url)
                };
            }

            assessRegionalRisk(url) {
                const domain = this.extractDomain(url);
                const localThreats = [];
                let riskLevel = 'low';

                // Check for Malaysian banking/e-wallet targeting
                this.malaysianBanks.forEach(bank => {
                    if (domain.includes(bank) && !this.isLegitemateDomain(domain, bank)) {
                        localThreats.push({
                            type: 'Banking Fraud',
                            target: bank.toUpperCase(),
                            severity: 'HIGH',
                            victims: Math.floor(Math.random() * 2000) + 500,
                            avgLoss: `RM ${Math.floor(Math.random() * 500) + 100}`,
                            description: `Fraudulent ${bank} domain targeting banking users`
                        });
                        riskLevel = 'high';
                    }
                });

                this.ewallets.forEach(ewallet => {
                    if (domain.includes(ewallet) && !this.isLegitemateDomain(domain, ewallet)) {
                        localThreats.push({
                            type: 'E-wallet Fraud',
                            target: ewallet.toUpperCase(),
                            severity: 'HIGH',
                            victims: Math.floor(Math.random() * 1500) + 200,
                            avgLoss: `RM ${Math.floor(Math.random() * 300) + 50}`,
                            description: `Fraudulent ${ewallet} domain targeting digital wallet users`
                        });
                        riskLevel = 'high';
                    }
                });

                return {
                    targetRegion: 'Malaysia',
                    riskLevel,
                    localThreats,
                    bankingRisk: riskLevel === 'high' ? 'high' : 'low',
                    ewalletRisk: riskLevel === 'high' ? 'high' : 'medium',
                    heatmapData: this.generateHeatmapData()
                };
            }

            generateHeatmapData() {
                return {
                    'Kuala Lumpur': { reports: 2847, risk: 'critical' },
                    'Selangor': { reports: 2156, risk: 'high' },
                    'Penang': { reports: 1234, risk: 'high' },
                    'Johor': { reports: 1876, risk: 'high' },
                    'Perak': { reports: 892, risk: 'medium' },
                    'Sabah': { reports: 567, risk: 'medium' },
                    'Sarawak': { reports: 743, risk: 'medium' }
                };
            }

            displayResults(results) {
                const resultsDiv = document.getElementById('results');
                const advancedDiv = document.getElementById('advancedResults');
                
                // Basic Results
                const riskClass = this.getRiskClass(results.basicAnalysis.riskLevel);
                const riskIcon = this.getRiskIcon(results.basicAnalysis.riskLevel);
                
                resultsDiv.innerHTML = `
                    <div class="alert alert-${riskClass}">
                        <div class="d-flex align-items-center mb-2">
                            <i data-feather="${riskIcon}" class="me-2"></i>
                            <strong>Risk Level: ${results.basicAnalysis.riskLevel.toUpperCase()}</strong>
                            <span class="badge bg-secondary ms-auto">Score: ${results.basicAnalysis.score}</span>
                        </div>
                        <p class="mb-2">${results.basicAnalysis.explanation}</p>
                        ${results.basicAnalysis.flags.length > 0 ? `
                            <div class="mt-2">
                                <small><strong>Detected Issues:</strong></small>
                                <ul class="small mb-0">
                                    ${results.basicAnalysis.flags.map(flag => `<li>${flag}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        ${results.aiAnalysis && !results.aiAnalysis.error ? `
                            <div class="mt-3 p-2 bg-light rounded">
                                <small><strong>AI Analysis:</strong> ${results.aiAnalysis.explanation}</small>
                            </div>
                        ` : ''}
                    </div>
                `;

                // Advanced Results
                this.displayAdvancedResults(results);
                
                resultsDiv.style.display = 'block';
                advancedDiv.style.display = 'block';
                feather.replace();
            }

            displayAdvancedResults(results) {
                // Fingerprint Analysis
                document.getElementById('fingerprintResults').innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>DNA Signature</h6>
                            <p><code>${results.fingerprint.hash}</code></p>
                            <p><strong>Risk Score:</strong> ${results.fingerprint.riskScore}/10</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Pattern Analysis</h6>
                            <small>Length: ${results.fingerprint.patterns[0]}, Subdomains: ${results.fingerprint.patterns[1]}</small><br>
                            <small>Hyphens: ${results.fingerprint.patterns[2]}, Numbers: ${results.fingerprint.patterns[3]}</small>
                        </div>
                    </div>
                `;

                // Redirect Chain
                document.getElementById('redirectResults').innerHTML = `
                    <div class="d-flex align-items-center mb-2">
                        <span class="badge bg-info me-2">${results.redirectChain.redirectCount} Redirects</span>
                        <span class="badge bg-${results.redirectChain.riskLevel === 'safe' ? 'success' : 'warning'}">${results.redirectChain.riskLevel.toUpperCase()}</span>
                    </div>
                    <div class="redirect-chain">
                        ${results.redirectChain.steps.map((step, index) => `
                            <div class="d-flex align-items-center mb-1">
                                <span class="badge bg-secondary me-2">${index + 1}</span>
                                <small class="text-truncate">${step.url}</small>
                                <span class="badge bg-${step.risk === 'high' ? 'danger' : 'success'} ms-auto">${step.risk}</span>
                            </div>
                        `).join('')}
                    </div>
                `;

                // Multilingual Analysis
                document.getElementById('multilingualResults').innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Detected Languages</h6>
                            ${results.multilingualAnalysis.detectedLanguages.map(lang => 
                                `<span class="badge bg-primary me-1">${lang}</span>`
                            ).join('') || '<span class="text-muted">None detected</span>'}
                        </div>
                        <div class="col-md-6">
                            <h6>Scam Keywords</h6>
                            ${results.multilingualAnalysis.scamKeywords.map(keyword => 
                                `<span class="badge bg-warning me-1">${keyword}</span>`
                            ).join('') || '<span class="text-muted">None detected</span>'}
                        </div>
                    </div>
                    <div class="mt-2">
                        <strong>Risk Score:</strong> ${results.multilingualAnalysis.riskScore}/10
                    </div>
                `;

                // Regional Risk
                document.getElementById('regionalResults').innerHTML = `
                    <div class="alert alert-${results.regionalRisk.riskLevel === 'high' ? 'danger' : 'info'}">
                        <h6><i data-feather="map-pin" class="me-2"></i>Malaysia Risk Assessment</h6>
                        <p><strong>Risk Level:</strong> ${results.regionalRisk.riskLevel.toUpperCase()}</p>
                        <p><strong>Banking Risk:</strong> ${results.regionalRisk.bankingRisk.toUpperCase()}</p>
                        <p><strong>E-wallet Risk:</strong> ${results.regionalRisk.ewalletRisk.toUpperCase()}</p>
                    </div>
                    ${results.regionalRisk.localThreats.length > 0 ? `
                        <div class="mt-3">
                            <h6>Local Threats Detected</h6>
                            ${results.regionalRisk.localThreats.map(threat => `
                                <div class="alert alert-warning">
                                    <strong>${threat.type}:</strong> ${threat.description}<br>
                                    <small>Target: ${threat.target} | Severity: ${threat.severity} | Avg Loss: ${threat.avgLoss}</small>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                `;

                // Generate heatmap
                this.generateRiskHeatmap(results.regionalRisk.heatmapData);
            }

            generateRiskHeatmap(data) {
                const canvas = document.getElementById('riskHeatmap');
                if (!canvas || !window.Chart) return;
                
                const ctx = canvas.getContext('2d');
                
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(data),
                        datasets: [{
                            label: 'Scam Reports',
                            data: Object.values(data).map(item => item.reports),
                            backgroundColor: Object.values(data).map(item => {
                                switch(item.risk) {
                                    case 'critical': return '#ef4444';
                                    case 'high': return '#f59e0b';
                                    case 'medium': return '#10b981';
                                    default: return '#6b7280';
                                }
                            }),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Regional Scam Reports by State'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            // QR Scanner Implementation - Alternative approach
            initializeQRScanner() {
                console.log('Initializing QR Scanner with alternative library...');
                
                // Check if QrScanner library is available
                if (typeof QrScanner !== 'undefined') {
                    try {
                        // Set up QR Scanner with the new library
                        QrScanner.WORKER_PATH = 'https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner-worker.min.js';
                        this.qrScannerReady = true;
                        console.log('QR Scanner library loaded successfully');
                        this.showToast('Success', 'QR Scanner ready for camera and file upload', 'success');
                    } catch (error) {
                        console.error('QR Scanner initialization error:', error);
                        this.qrScannerReady = false;
                    }
                } else {
                    console.log('QrScanner library not found, initializing file-only mode');
                    this.qrScannerReady = false;
                    this.showToast('Info', 'QR Scanner initialized in file-upload mode', 'info');
                }
            }

            switchQRMode(mode) {
                const cameraBtn = document.getElementById('cameraMode');
                const fileBtn = document.getElementById('fileMode');
                const qrReader = document.getElementById('qr-reader');
                const fileButton = document.getElementById('qr-file-button');

                if (mode === 'camera') {
                    cameraBtn.classList.add('active');
                    fileBtn.classList.remove('active');
                    qrReader.style.display = 'block';
                    fileButton.style.display = 'none';
                    this.startQRCamera();
                } else {
                    fileBtn.classList.add('active');
                    cameraBtn.classList.remove('active');
                    qrReader.style.display = 'none';
                    fileButton.style.display = 'block';
                    this.stopQRCamera();
                }
            }

            async startQRCamera() {
                if (!this.qrScannerReady) {
                    this.showToast('Error', 'QR Scanner not available. Please use file upload mode.', 'error');
                    this.switchQRMode('file');
                    return;
                }

                try {
                    const videoElement = document.getElementById('qr-reader');
                    if (!videoElement) {
                        throw new Error('Video element not found');
                    }

                    // Stop any existing scanner
                    if (this.activeQrScanner) {
                        this.activeQrScanner.destroy();
                    }

                    // Create new QR scanner instance
                    this.activeQrScanner = new QrScanner(
                        videoElement,
                        (result) => {
                            console.log('QR Code detected:', result.data);
                            this.handleQRResult(result.data);
                        },
                        {
                            onDecodeError: (error) => {
                                // Ignore frequent scanning errors
                                if (!error.message.includes('No QR code found')) {
                                    console.log('QR Scanner decode error:', error.message);
                                }
                            },
                            preferredCamera: 'environment',
                            highlightScanRegion: true,
                            highlightCodeOutline: true,
                            maxScansPerSecond: 5
                        }
                    );

                    await this.activeQrScanner.start();
                    this.showToast('Success', 'Camera started successfully. Point at a QR code to scan.', 'success');

                } catch (error) {
                    console.error('Camera access failed:', error);
                    let errorMessage = 'Camera access failed. Please use file upload mode.';
                    
                    if (error.name === 'NotAllowedError') {
                        errorMessage = 'Camera permission denied. Please allow camera access and try again.';
                    } else if (error.name === 'NotFoundError') {
                        errorMessage = 'No camera found on this device. Please use file upload mode.';
                    } else if (error.name === 'NotSupportedError') {
                        errorMessage = 'Camera not supported on this device. Please use file upload mode.';
                    }
                    
                    this.showToast('Warning', errorMessage, 'warning');
                    this.switchQRMode('file');
                }
            }

            async stopQRCamera() {
                if (this.activeQrScanner) {
                    try {
                        this.activeQrScanner.stop();
                        this.activeQrScanner.destroy();
                        this.activeQrScanner = null;
                    } catch (error) {
                        console.warn('Failed to stop camera:', error);
                    }
                }
            }

            async handleQRFile(event) {
                const file = event.target.files[0];
                if (!file) return;

                // Show loading state
                const resultsDiv = document.getElementById('qr-results');
                resultsDiv.innerHTML = `
                    <div class="alert alert-info">
                        <i data-feather="loader" class="me-2"></i>
                        Processing QR code image...
                    </div>
                `;
                feather.replace();

                try {
                    // Use the new QR scanner library for file scanning
                    if (this.qrScannerReady && typeof QrScanner !== 'undefined') {
                        const result = await QrScanner.scanImage(file);
                        console.log('QR Code detected from file:', result);
                        this.handleQRResult(result);
                        return;
                    }

                    // Fallback: manual input if scanning fails
                    this.showManualQRInput();

                } catch (error) {
                    console.error('QR scan error:', error);
                    
                    // Show manual input option if automatic scanning fails
                    this.showManualQRInput();
                }
            }

            async processQRImageAlternative(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            try {
                                // Create canvas for image processing
                                const canvas = document.createElement('canvas');
                                const ctx = canvas.getContext('2d');
                                canvas.width = img.width;
                                canvas.height = img.height;
                                ctx.drawImage(img, 0, 0);

                                // Try to initialize QR scanner if not available
                                if (!this.qrScanner && typeof Html5Qrcode !== 'undefined') {
                                    this.qrScanner = new Html5Qrcode("qr-reader");
                                }

                                // If still no scanner, show manual input option
                                if (!this.qrScanner) {
                                    this.showManualQRInput();
                                    resolve();
                                    return;
                                }

                                // Convert canvas to blob and try scanning
                                canvas.toBlob(async (blob) => {
                                    try {
                                        const result = await this.qrScanner.scanFile(blob, true);
                                        this.handleQRResult(result);
                                        resolve();
                                    } catch (error) {
                                        this.showManualQRInput();
                                        resolve();
                                    }
                                });

                            } catch (error) {
                                this.showManualQRInput();
                                resolve();
                            }
                        };
                        img.onerror = () => {
                            reject(new Error('Failed to load image'));
                        };
                        img.src = e.target.result;
                    };
                    reader.onerror = () => {
                        reject(new Error('Failed to read file'));
                    };
                    reader.readAsDataURL(file);
                });
            }

            showManualQRInput() {
                const resultsDiv = document.getElementById('qr-results');
                resultsDiv.innerHTML = `
                    <div class="alert alert-secondary">
                        <h6><i data-feather="edit-3" class="me-2"></i>Manual QR Code Input</h6>
                        <p class="small mb-3">Could not automatically scan the QR code. Please enter the QR code content manually:</p>
                        <div class="input-group">
                            <input type="text" class="form-control" id="manual-qr-input" placeholder="Paste QR code content here...">
                            <button class="btn btn-primary" onclick="window.paysar.processManualQR()">
                                <i data-feather="search" class="me-1"></i>Analyze
                            </button>
                        </div>
                    </div>
                `;
                feather.replace();
            }

            processManualQR() {
                const input = document.getElementById('manual-qr-input');
                const content = input.value.trim();
                if (content) {
                    this.handleQRResult(content);
                } else {
                    this.showToast('Warning', 'Please enter QR code content', 'warning');
                }
            }

            handleQRResult(decodedText) {
                const resultsDiv = document.getElementById('qr-results');
                
                // Analyze QR code for payment and security threats
                const qrAnalysis = this.analyzeQRCode(decodedText);
                
                resultsDiv.innerHTML = `
                    <div class="qr-analysis-result">
                        ${this.renderQRAnalysis(qrAnalysis)}
                    </div>
                `;
                feather.replace();
                
                // If it's a URL, also perform link analysis
                if (qrAnalysis.isUrl) {
                    this.scanQRUrl(decodedText);
                }
            }

            analyzeQRCode(content) {
                const analysis = {
                    content: content,
                    isUrl: false,
                    isPayment: false,
                    paymentType: null,
                    riskLevel: 'safe',
                    riskScore: 0,
                    warnings: [],
                    details: {}
                };

                // Check if it's a URL
                if (this.isValidUrl(content)) {
                    analysis.isUrl = true;
                    analysis.details.url = content;
                    
                    // Check for payment-related URLs
                    const paymentPatterns = [
                        { pattern: /pay\./, type: 'Generic Payment' },
                        { pattern: /duitnow/i, type: 'DuitNow' },
                        { pattern: /maybank/i, type: 'Maybank' },
                        { pattern: /cimb/i, type: 'CIMB Bank' },
                        { pattern: /publicbank/i, type: 'Public Bank' },
                        { pattern: /rhb/i, type: 'RHB Bank' },
                        { pattern: /grabpay/i, type: 'GrabPay' },
                        { pattern: /boost\.my/i, type: 'Boost' },
                        { pattern: /tng\.digital/i, type: 'Touch n Go' }
                    ];

                    for (const { pattern, type } of paymentPatterns) {
                        if (pattern.test(content)) {
                            analysis.isPayment = true;
                            analysis.paymentType = type;
                            break;
                        }
                    }
                }

                // Check for Malaysian payment QR formats
                if (!analysis.isUrl) {
                    // DuitNow QR format detection
                    if (content.includes('MY.') || content.includes('DUITNOW')) {
                        analysis.isPayment = true;
                        analysis.paymentType = 'DuitNow QR';
                        analysis.details.format = 'Malaysian Payment Standard';
                    }
                    
                    // Bank transfer format
                    if (content.match(/^\d{10,12}$/)) {
                        analysis.isPayment = true;
                        analysis.paymentType = 'Bank Account';
                        analysis.details.accountNumber = content.substring(0, 4) + '****';
                    }
                }

                // Risk assessment
                if (analysis.isPayment) {
                    analysis.riskScore += this.assessPaymentRisk(content, analysis.paymentType);
                }

                if (analysis.isUrl) {
                    analysis.riskScore += this.assessUrlRisk(content);
                }

                // Determine risk level
                if (analysis.riskScore >= 5) {
                    analysis.riskLevel = 'high';
                } else if (analysis.riskScore >= 3) {
                    analysis.riskLevel = 'medium';
                } else {
                    analysis.riskLevel = 'safe';
                }

                return analysis;
            }

            assessPaymentRisk(content, paymentType) {
                let risk = 0;
                const warnings = [];

                // Check for suspicious payment characteristics
                if (content.includes('urgent') || content.includes('limited time')) {
                    risk += 2;
                    warnings.push('Contains urgency keywords');
                }

                // Check for non-standard domains in payment URLs
                if (this.isValidUrl(content)) {
                    const domain = this.extractDomain(content);
                    const trustedDomains = [
                        'maybank.com', 'cimb.com', 'publicbank.com.my', 
                        'rhbgroup.com', 'grab.com', 'boost.my', 'touchngo.com.my'
                    ];
                    
                    if (!trustedDomains.some(trusted => domain.includes(trusted))) {
                        risk += 3;
                        warnings.push('Unknown payment domain');
                    }
                }

                return risk;
            }

            assessUrlRisk(url) {
                let risk = 0;
                
                // Use existing URL risk assessment
                const domain = this.extractDomain(url);
                
                // Check for suspicious TLDs
                const suspiciousTlds = ['.tk', '.ml', '.ga', '.cf'];
                if (suspiciousTlds.some(tld => domain.endsWith(tld))) {
                    risk += 2;
                }

                // Check for URL shorteners
                if (this.isUrlShortener(url)) {
                    risk += 1;
                }

                return risk;
            }

            renderQRAnalysis(analysis) {
                const riskColors = {
                    safe: 'success',
                    medium: 'warning', 
                    high: 'danger'
                };

                const riskIcons = {
                    safe: 'shield-check',
                    medium: 'alert-triangle',
                    high: 'alert-octagon'
                };

                let html = `
                    <div class="alert alert-${riskColors[analysis.riskLevel]}">
                        <h6>
                            <i data-feather="${riskIcons[analysis.riskLevel]}" class="me-2"></i>
                            QR Code Security Analysis
                        </h6>
                `;

                if (analysis.isPayment) {
                    html += `
                        <div class="payment-info mb-3">
                            <strong>Payment QR Detected: ${analysis.paymentType}</strong>
                            ${analysis.details.format ? `<br><small>Format: ${analysis.details.format}</small>` : ''}
                            ${analysis.details.accountNumber ? `<br><small>Account: ${analysis.details.accountNumber}</small>` : ''}
                        </div>
                    `;
                }

                html += `
                    <div class="risk-assessment">
                        <span class="badge bg-${riskColors[analysis.riskLevel]} me-2">
                            Risk Level: ${analysis.riskLevel.toUpperCase()}
                        </span>
                        <span class="badge bg-secondary">Score: ${analysis.riskScore}/10</span>
                    </div>
                `;

                if (analysis.warnings.length > 0) {
                    html += `
                        <div class="warnings mt-2">
                            <small><strong>Security Warnings:</strong></small>
                            <ul class="small mb-0">
                                ${analysis.warnings.map(warning => `<li>${warning}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }

                if (analysis.isUrl) {
                    html += `
                        <div class="mt-3">
                            <button class="btn btn-primary btn-sm" onclick="window.paysar.scanQRUrl('${analysis.content}')">
                                <i data-feather="search" class="me-1"></i>Analyze URL Details
                            </button>
                        </div>
                    `;
                }

                // Security recommendations
                const recommendations = this.getQRSecurityRecommendations(analysis);
                if (recommendations.length > 0) {
                    html += `
                        <div class="recommendations mt-3">
                            <small><strong>Security Recommendations:</strong></small>
                            <ul class="small mb-0">
                                ${recommendations.map(rec => `<li>${rec}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }

                html += `</div>`;
                return html;
            }

            getQRSecurityRecommendations(analysis) {
                const recommendations = [];

                if (analysis.riskLevel === 'high') {
                    recommendations.push('Do not proceed with this payment - high security risk detected');
                    recommendations.push('Report this QR code to relevant authorities');
                }

                if (analysis.riskLevel === 'medium') {
                    recommendations.push('Verify the payment recipient through alternative means');
                    recommendations.push('Double-check the payment amount before confirming');
                }

                if (analysis.isPayment) {
                    recommendations.push('Always verify payment details before scanning');
                    recommendations.push('Only scan QR codes from trusted sources');
                    recommendations.push('Check your bank statements regularly');
                }

                if (analysis.isUrl && !analysis.isPayment) {
                    recommendations.push('Be cautious when visiting URLs from QR codes');
                    recommendations.push('Verify the website authenticity before entering personal information');
                }

                return recommendations;
            }

            scanQRUrl(url) {
                document.getElementById('urlInput').value = url;
                this.handleScan();
            }

            // Chat Implementation
            async sendChatMessage() {
                const input = document.getElementById('chatInput');
                const message = input.value.trim();
                if (!message) return;

                this.addChatMessage(message, 'user');
                input.value = '';

                // Debug API key
                console.log('API Key available:', this.apiKey ? 'Yes' : 'No');
                console.log('API Key length:', this.apiKey ? this.apiKey.length : 0);

                if (!this.apiKey || this.apiKey.length < 20) {
                    this.addChatMessage('I need a valid OpenAI API key to provide AI-powered assistance. Please check your API key configuration.', 'bot');
                    return;
                }

                try {
                    const response = await this.getChatResponse(message);
                    this.addChatMessage(response, 'bot');
                } catch (error) {
                    console.error('Chat error:', error);
                    this.addChatMessage(`Sorry, I encountered an error: ${error.message}. Please check your API key and try again.`, 'bot');
                }
            }

            async getChatResponse(message) {
                // Ensure we have a clean API key
                const cleanApiKey = this.apiKey.trim();
                console.log('Making API request with key starting with:', cleanApiKey.substring(0, 10) + '...');

                const response = await fetch(this.baseUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${cleanApiKey}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o',
                        messages: [
                            {
                                role: 'system',
                                content: 'You are a cybersecurity expert specializing in Malaysian online scams, phishing, and digital security. Provide helpful, accurate advice about online safety, scam detection, and cybersecurity best practices specifically for Malaysian users.'
                            },
                            { role: 'user', content: message }
                        ],
                        max_tokens: 300,
                        temperature: 0.7
                    })
                });

                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('API Error:', errorData);
                    throw new Error(`Chat API request failed: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
                }

                const data = await response.json();
                return data.choices[0].message.content;
            }

            addChatMessage(message, sender) {
                const chatMessages = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}`;
                
                // Format bot messages professionally
                const formattedMessage = sender === 'bot' ? this.formatBotMessage(message) : message;
                
                messageDiv.innerHTML = `
                    <div class="message-content">
                        ${formattedMessage}
                    </div>
                `;
                
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            formatBotMessage(message) {
                return message
                    // Convert numbered lists to HTML
                    .replace(/(\d+\.\s\*\*[^*]+\*\*:)/g, '<div class="scam-item"><strong>$1</strong>')
                    .replace(/(\d+\.\s)([^:]+:)/g, '<div class="scam-item"><strong>$1$2</strong>')
                    // Convert bold text
                    .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                    // Handle paragraphs and line breaks
                    .replace(/\n\n/g, '</div><div class="message-section">')
                    .replace(/\n/g, '<br>')
                    // Wrap in sections
                    .replace(/^/, '<div class="message-section">')
                    .replace(/$/, '</div>')
                    // Clean up list items
                    .replace(/<div class="scam-item"><strong>([^<]+)<\/strong>([^<]*?)(?=<div class="scam-item">|<\/div>|$)/g, 
                            '<div class="scam-item"><strong>$1</strong>$2</div>');
            }

            showWelcomeMessage() {
                setTimeout(() => {
                    this.showToast('Welcome', 'PaySavvy Pro is ready! All features are functional and deployment-ready.', 'success');
                }, 1000);
            }

            // Utility Functions
            isValidUrl(string) {
                try {
                    new URL(string);
                    return true;
                } catch {
                    return false;
                }
            }

            extractDomain(url) {
                try {
                    return new URL(url).hostname.toLowerCase();
                } catch {
                    return url.toLowerCase();
                }
            }

            isUrlShortener(url) {
                const shorteners = ['bit.ly', 'tinyurl.com', 't.co', 'short.link', 'ow.ly'];
                return shorteners.some(shortener => url.includes(shortener));
            }

            simpleHash(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return Math.abs(hash);
            }

            calculateFingerprintRisk(patterns) {
                let risk = 0;
                risk += patterns[0] > 100 ? 2 : 0; // Long URL
                risk += patterns[1] > 4 ? 2 : 0; // Many subdomains
                risk += patterns[2] > 3 ? 2 : 0; // Many hyphens
                risk += patterns[3] > 10 ? 2 : 0; // Many numbers
                risk += patterns[5] === 0 ? 2 : 0; // No HTTPS
                return Math.min(risk, 10);
            }

            checkFingerprintDatabase(hash) {
                // Simulate database lookup
                const knownScams = ['a1b2c3d4', 'e5f6g7h8', '12345678'];
                return knownScams.includes(hash) ? 1 : 0;
            }

            getRegionalThreats(url) {
                const threats = ['Malaysia-targeted scam'];
                if (url.includes('bank') || url.includes('pay')) {
                    threats.push('Financial fraud');
                }
                return threats;
            }

            generateExplanation(riskLevel, flags) {
                switch (riskLevel) {
                    case 'dangerous':
                        return 'High risk - multiple threat indicators detected. Do not interact with this link.';
                    case 'suspicious':
                        return 'Medium risk - suspicious patterns detected. Exercise caution.';
                    default:
                        return 'Low risk - no major threats detected.';
                }
            }

            getRiskClass(riskLevel) {
                switch (riskLevel) {
                    case 'dangerous': return 'danger';
                    case 'suspicious': return 'warning';
                    default: return 'success';
                }
            }

            getRiskIcon(riskLevel) {
                switch (riskLevel) {
                    case 'dangerous': return 'alert-triangle';
                    case 'suspicious': return 'alert-circle';
                    default: return 'check-circle';
                }
            }

            // Storage Functions
            loadScanHistory() {
                try {
                    return JSON.parse(localStorage.getItem('paysavvy_scan_history') || '[]');
                } catch {
                    return [];
                }
            }

            saveScanResult(results) {
                this.scanHistory.unshift({
                    ...results,
                    id: Date.now(),
                    timestamp: new Date().toISOString()
                });

                // Keep only last 20 scans
                this.scanHistory = this.scanHistory.slice(0, 20);
                localStorage.setItem('paysavvy_scan_history', JSON.stringify(this.scanHistory));
            }

            displayScanHistory() {
                const historyDiv = document.getElementById('historyContent');
                const clearBtn = document.getElementById('clearHistory');

                if (this.scanHistory.length === 0) {
                    historyDiv.innerHTML = '<p class="text-muted">No scans yet. Start by analyzing a suspicious link above.</p>';
                    clearBtn.style.display = 'none';
                    return;
                }

                clearBtn.style.display = 'block';
                historyDiv.innerHTML = this.scanHistory.map(scan => `
                    <div class="d-flex align-items-center justify-content-between p-2 border-bottom">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-1">
                                <span class="badge bg-${this.getRiskClass(scan.basicAnalysis.riskLevel)} me-2">
                                    ${scan.basicAnalysis.riskLevel.toUpperCase()}
                                </span>
                                <small class="text-muted">${new Date(scan.timestamp).toLocaleString()}</small>
                            </div>
                            <small class="text-truncate d-block" style="max-width: 300px;">${scan.url}</small>
                        </div>
                        <button class="btn btn-outline-primary btn-sm" onclick="window.paysar.rescanUrl('${scan.url}')">
                            <i data-feather="refresh-cw" width="14" height="14"></i>
                        </button>
                    </div>
                `).join('');
                feather.replace();
            }

            rescanUrl(url) {
                document.getElementById('urlInput').value = url;
                this.handleScan();
            }

            clearScanHistory() {
                this.scanHistory = [];
                localStorage.removeItem('paysavvy_scan_history');
                this.displayScanHistory();
                this.showToast('Success', 'Scan history cleared', 'success');
            }

            // UI Functions
            setLoadingState(loading) {
                const button = document.getElementById('scanButton');
                if (loading) {
                    button.disabled = true;
                    button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Analyzing...';
                } else {
                    button.disabled = false;
                    button.innerHTML = '<i data-feather="search" class="me-2"></i>Scan Link Now';
                    feather.replace();
                }
            }

            toggleCollapsible(header) {
                const target = header.dataset.target;
                const content = document.getElementById(target);
                const icon = header.querySelector('i[data-feather="chevron-down"], i[data-feather="chevron-up"]');

                if (content && content.classList.contains('show')) {
                    content.classList.remove('show');
                    if (icon) icon.setAttribute('data-feather', 'chevron-down');
                } else if (content) {
                    content.classList.add('show');
                    if (icon) icon.setAttribute('data-feather', 'chevron-up');
                }
                feather.replace();
            }

            showToast(title, message, type = 'info') {
                const toastContainer = document.querySelector('.toast-container');
                const toastId = 'toast-' + Date.now();
                
                const bgClass = {
                    'success': 'bg-success',
                    'error': 'bg-danger',
                    'warning': 'bg-warning',
                    'info': 'bg-info'
                }[type] || 'bg-info';

                const toastHtml = `
                    <div id="${toastId}" class="toast" role="alert">
                        <div class="toast-header ${bgClass} text-white">
                            <strong class="me-auto">${title}</strong>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                        </div>
                        <div class="toast-body">
                            ${message}
                        </div>
                    </div>
                `;

                toastContainer.insertAdjacentHTML('beforeend', toastHtml);
                const toastElement = document.getElementById(toastId);
                
                if (window.bootstrap && window.bootstrap.Toast) {
                    const toast = new bootstrap.Toast(toastElement);
                    toast.show();

                    toastElement.addEventListener('hidden.bs.toast', () => {
                        toastElement.remove();
                    });
                }
            }
        }

        // Initialize PaySavvy Pro
        document.addEventListener('DOMContentLoaded', () => {
            window.paysar = new PaySavvyPro();
        });
    </script>
</body>
</html>